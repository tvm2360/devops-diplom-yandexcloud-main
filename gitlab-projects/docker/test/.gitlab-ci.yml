stages:
  - push

.dind: &dind_template
  stage: push
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - cat $CI_SA_PUSHER_KEY_BASE64 | base64 -d | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY/$CI_REPOSITORY

push:latest:
  <<: *dind_template
  script:
    - docker build -t $CI_REGISTRY/$CI_REPOSITORY/docker-image-test-tvm2360:latest .
    - docker push $CI_REGISTRY/$CI_REPOSITORY/docker-image-test-tvm2360:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
    - if: '$CI_MERGE_REQUEST_APPROVED && $CI_COMMIT_BRANCH == "main"'

push:tag:
  <<: *dind_template
  script:
    - docker build -t $CI_REGISTRY/$CI_REPOSITORY/docker-image-test-tvm2360:$CI_COMMIT_TAG.
    - docker push $CI_REGISTRY/$CI_REPOSITORY/docker-image-test-tvm2360:$CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_TAG'
